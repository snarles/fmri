---
title: "WhyThingsGoWrong"
author: "Yuval Benjamini"
date: "15 March 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Let's first read the data from the two repeats.
```{r try,cache = TRUE,echo = FALSE, message = FALSE}

library('R.matlab')

dat_1 = R.matlab::readMat('/Users/yuvalb/Dropbox/File requests/Matrices/Charles Zheng - All_Sub_Rest1.mat')
dat_2 = R.matlab::readMat('/Users/yuvalb/Dropbox/File requests/Matrices/Charles Zheng - All_Sub_Rest2.mat')

```

When matrices match, they give very similar values. We 
can see this on an average - difference plot.
The following function draws these plots. 
The first value indexes the cor-matrix from the first data set. The second value indexes the cor-matrix from the second data set.
You can specify a row to plot an individual one.

```{r plot_avg_diff}

avg_diff_plot = function(first_cor,second_cor,row = 0, newp = FALSE,...) {
    if (row > 0){
        vec_a = dat_1$All.Sub[first_cor,c,]
        vec_b = dat_2$All.Sub[second_cor,c,]
    } else{
        vec_a = dat_1$All.Sub[first_cor,,]
        vec_b = dat_2$All.Sub[second_cor,,]
    }
    if (newp){
        plot((vec_a+vec_b)/2,
             vec_a - vec_b,
             xlim = c(-.5,1.6), ylim = c(-1.6,1.6),...)
        abline(h = 0, col = 4, lw = 3,xlab = "Avg", ylab = "Diff")
    } else {
        points((vec_a+vec_b)/2,
             vec_a - vec_b,
             xlim = c(-.5,1.6), ylim = c(-1.6,1.6),...)
    }
}
```

Now we'll look at a few of this plots for the usual data. 
We can compare matched examples: 
```{r}
avg_diff_plot(100,100,col = 1, pch = 20, cex = 0.3,newp = TRUE)
avg_diff_plot(8,8,col = 1, pch = 20, cex = 0.3,newp = TRUE)
avg_diff_plot(6,6,col = 1, pch = 20, cex = 0.3,newp = TRUE)
```

And contrast this with non-matched examples
```{r}
avg_diff_plot(100,1,col = 1, pch = 20, cex = 0.3,newp = TRUE)
avg_diff_plot(8,2,col = 1, pch = 20, cex = 0.3,newp = TRUE)
avg_diff_plot(6,3,col = 1, pch = 20, cex = 0.3,newp = TRUE)
```

Now we can see a problematic example (#7):
```{r}
avg_diff_plot(7,7,col = 1, pch = 20, cex = 0.3,newp = TRUE)
```
In this example, we can actually see a split. 
The cause here is the sample from the first data set. Indeed, when we will try to decode it, we will get much larger numbers. 


If we compare this to the pair (7,8), it doesn't look much worse
```{r}
avg_diff_plot(7,8,col = 1, pch = 20, cex = 0.3,newp = TRUE)
```


## Distribution of scores.
Now, let's look at the distribution of similarity scores.

We will try out different scores:

1.  $s_{corr}(\Sigma_a, \Sigma_b) =   Corr(vec(\Sigma_a),vec(\Sigma_a))$
2.  $s_{mse}(\Sigma_a, \Sigma_b) =   -\|vec(\Sigma_a)-vec(\Sigma_a))\|$
3.  $s_{KL}(\Sigma_a, \Sigma_b) = trace(\Sigma_a \Sigma_b^{-1}) - log(|\Sigma_a \Sigma_b^{-1})|)$

All of these will have the shared property that 
$$ s(\Sigma_{a,7}, \Sigma_{b,8}) > s(\Sigma_{a,7}, \Sigma_{b,7}) $$
and therefore the identification will be wrong.

```{r similarities_defs, cache = TRUE}
s_cor = function(sig_a, sig_b) { cor(as.numeric(sig_a),as.numeric(sig_b))}   

s_mse = function(sig_a, sig_b) { -norm(sig_a -sig_b,type = "2")}

s_kl  = function(sig_a,sig_b) {
    a_binv = sig_a %*% solve(sig_b)
    b_ainv = sig_b %*% solve(sig_a)
    dist_a = sum(diag(a_binv)) - log(det(a_binv))
    dist_b = sum(diag(b_ainv)) - log(det(b_ainv))
    -min(dist_a,dist_b)
}


```

Now lets build the similarity matrices for the first 10 cases. 

```{r run_sims, cache = TRUE}
inds = 1:50
simils = list()
for (k in 1:3) { 
    simils[[k]] = matrix(nr = length(inds),nc = length(inds))
}
sim_funcs = list(cor = s_cor, mse = s_mse, kl = s_kl)
for (i in inds){
    for (j in inds) {
        for (k in 1:3) {
            simils[[k]][i,j] =  sim_funcs[[k]](dat_1$All.Sub[i,,],dat_2$All.Sub[j,,])
        }
    }
}


```

The following are images of the three statisics.
The way to see this matrix: 

- Brighter is better
- Data-set 1 correct id if dot brightest in *row*
- Data-set 2 correct id if dot brightest in *column*

```{r plot_sims}
par(mfcol = c(3,1),mar = c(2,2,2,2))
image(simils[[1]], main = "Correlation similarity",
      xlab = "Rest 1", ylab = "Rest 2")
image(simils[[2]], main = "MSE similarity",
      xlab = "Rest 1", ylab = "Rest 2")
image(simils[[3]], main = "KL similarity",
      xlab = "Rest 1", ylab = "Rest 2")

```

Here is what the scores look like for a good example
```{r scores_good}
draw_scores = function(scores_mat,example,...){
    plot(density(scores_mat[example,]),col =0,...)
    lines(density(scores_mat[example,-example]),...)
    rug(scores_mat[example,-example])
    abline(v = scores_mat[example,example],col = 4, lw=4)
}

par(mfcol = c(3,1))
draw_scores(simils[[1]],1,main= "Corr, example 1")
draw_scores(simils[[2]],1,main= "MSE, example 1")
draw_scores(simils[[3]],1,main= "KL, example 1")

i = 4
par(mfcol = c(3,1))
draw_scores(simils[[1]],i,main= sprintf("Corr, example %.f",i))
draw_scores(simils[[2]],i,main= sprintf("MSE, example %.f",i))
draw_scores(simils[[3]],i,main= sprintf("KL, example %.f",i))

```
We see that MSE fails here pretty miserably. 
There seems to be a general correlation effect that is not consistent in individuals. 


For both Cor and MSE, example 7 fails.
For the KL it doesn't (and really it still has quite small variability).

```{r scores_7}
par(mfcol = c(3,1))
draw_scores(simils[[1]],7,main= "Corr, example 7")
draw_scores(simils[[2]],7,main= "MSE, example 7")
draw_scores(simils[[3]],7,main= "KL, example 7")
```


```{r eigen_break}
break_kl  = function(sig_a,sig_b) {
    a_binv = solve(sig_a,sig_b)
    es_a_binv = eigen(a_binv) 
    errors = es_a_binv$values - log(es_a_binv$values)
    return(errors)
}


i = 20; j = 5
plot(break_kl(dat_1$All.Sub[i,,],dat_2$All.Sub[i,,]), break_kl(dat_1$All.Sub[i,,],dat_2$All.Sub[j,,]),col = 0)
text(break_kl(dat_1$All.Sub[i,,],dat_2$All.Sub[i,,]), break_kl(dat_1$All.Sub[i,,],dat_2$All.Sub[j,,]),cex = 0.5)
abline(0,1)
```



